# Skrooge GitHub Actions

This directory contains reusable GitHub Actions for running skrooge cost estimation and automatically commenting results on pull requests.

## Available Actions

### 1. skrooge-comment

A simple action that runs skrooge with provided parameters and comments the output on PRs.

**Usage in other repositories:**

```yaml
name: Cost Estimation
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  estimate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run skrooge cost estimation
        uses: mwarkentin/skrooge/.github/actions/skrooge-comment@main
        with:
          replicas: '5'
          cpu: '2000'
          mem: '4096'
          instance: 'c2-standard-30'
          cost-class: 'sud'
          region: 'us-central1'
          format: 'english'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-prefix: '## ðŸ’° Deployment Cost Estimate'
```

**Inputs:**
- `replicas` (optional): Number of replicas in the deployment (default: '1')
- `cpu` (optional): CPU change in milli-cores (default: '0')
- `mem` (optional): Memory change in MiB (default: '0')
- `instance` (required): Instance type this deployment is running on
- `cost-class` (optional): Type of cost to calculate (default: 'sud')
- `region` (optional): Region to use for cost calculation (default: 'us-central1')
- `format` (optional): Output format - 'english' or 'json' (default: 'english')
- `github-token` (required): GitHub token for commenting on PRs
- `comment-prefix` (optional): Prefix for the comment (default: '## ðŸ’° Skrooge Cost Estimate')

### 2. skrooge-k8s-parser

An advanced action that automatically parses Kubernetes manifests to extract resource requirements and runs skrooge cost estimation.

**Usage in other repositories:**

```yaml
name: K8s Cost Analysis
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**/deployment.yaml'
      - '**/deployment.yml'
      - '**/statefulset.yaml'
      - '**/statefulset.yml'

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze Kubernetes manifests and estimate costs
        uses: mwarkentin/skrooge/.github/actions/skrooge-k8s-parser@main
        with:
          manifest-path: '.'
          instance: 'c2-standard-30'
          cost-class: 'sud'
          region: 'us-central1'
          format: 'english'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-prefix: '## ðŸ’° Kubernetes Cost Analysis'
```

**Inputs:**
- `manifest-path` (optional): Path to Kubernetes manifest file(s) (default: '.')
- `instance` (required): Instance type this deployment is running on
- `cost-class` (optional): Type of cost to calculate (default: 'sud')
- `region` (optional): Region to use for cost calculation (default: 'us-central1')
- `format` (optional): Output format - 'english' or 'json' (default: 'english')
- `github-token` (required): GitHub token for commenting on PRs
- `comment-prefix` (optional): Prefix for the comment (default: '## ðŸ’° Kubernetes Cost Analysis')

## Supported Kubernetes Resources

The `skrooge-k8s-parser` action currently supports:

- **Deployments**: Extracts replicas, CPU, and memory requests from all containers
- **StatefulSets**: Extracts replicas, CPU, and memory requests from all containers

## Cost Classes

Available cost classes for GCP instances:
- `sud`: Sustained Use Discount (default)
- `ondemand`: On-demand pricing
- `preemptible`: Preemptible instances
- `cud-1y`: 1-year Committed Use Discount
- `cud-3y`: 3-year Committed Use Discount

## Regions

The actions support all major GCP regions. Default is `us-central1`.

## Example Output

The actions will comment on PRs with output like:

```
## ðŸ’° Kubernetes Cost Analysis

**Resources Detected:**
```
CPU: 5000m, Memory: 8192Mi, Replicas: 5
```

**Cost Estimate:**
```
This workload is running on c2-standard-30 instances in us-central1 with 30 cores and 120GiB of memory.
This workload will require 5.0 cores and 8.0 GiB of memory. This workload is cores-constrained.
This workload will require 1 instances, costing $0.125/h (or $91.40/m (or $1096.80/y)) at sud rates.
```

*Generated by skrooge - A Kubernetes cost estimator*
```

## Requirements

- Python 3.8+
- GitHub Actions permissions for pull request comments
- Valid GCP instance type name
